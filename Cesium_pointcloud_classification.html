<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>Cesium 点群分類機能Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Cesium CDN（バージョンは必要に応じて固定） -->
  <link rel="stylesheet" href="https://unpkg.com/cesium@1.120.0/Build/Cesium/Widgets/widgets.css">
  <style>
    html, body, #cesiumContainer { width:100%; height:100%; margin:0; padding:0; overflow:hidden; }
  </style>
</head>
<body>
  <div id="cesiumContainer"></div>

  <script src="https://unpkg.com/cesium@1.120.0/Build/Cesium/Cesium.js"></script>
  <script>
// 公開用トークン
Cesium.Ion.defaultAccessToken = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI4Y2ZlMjY3NC0wMjYyLTQwM2QtYWNlYi04YjU2OWZkNjg0NjMiLCJpZCI6MTk4Njc1LCJpYXQiOjE3NTUwMDgzNjV9.bGpVqh1jBe3onROG352ZZuMisD4UBDGudxXslQkL-ns";

var viewer = new Cesium.Viewer("cesiumContainer", {
  timeline: false,
  animation: false,
});
viewer.scene.globe.depthTestAgainstTerrain = true;

// 地形設定（Japan Regional Terrain）
(function setTerrain(v){
  function fallbackOld(){
    if (Cesium.CesiumTerrainProvider &&
        typeof Cesium.CesiumTerrainProvider.fromIonAssetId === "function") {
      Cesium.CesiumTerrainProvider.fromIonAssetId(2767062)
        .then(function(p){ v.terrainProvider = p; })
        .catch(function(e){ console.error("Terrain(old) error:", e); });
    }
  }
  if (Cesium.Terrain && typeof Cesium.Terrain.fromIonAssetId === "function") {
    try {
      v.terrainProvider = Cesium.Terrain.fromIonAssetId(2767062, { requestVertexNormals: true });
    } catch(e){ console.error("Terrain(new) error:", e); fallbackOld(); }
  } else { fallbackOld(); }
})(viewer);

// 左右アセット ID
var LEFT_ID  = 3621736;
var RIGHT_ID = 3621692;

// 分類定義
var CLASSES = [
  { label: "地面",   value: 2  },
  { label: "フェンス", value: 4  },
  { label: "植生",   value: 5  },
  { label: "建物",   value: 6  },
  { label: "電線",   value: 14 },
  { label: "電柱",   value: 20 },
  { label: "車",     value: 21 }
];

var tilesetLeft, tilesetRight;
var defaultColorLeft = null;
var selected = {};
var btnByValue = {};

// スタイル
(function injectStyles(){
  var style = document.createElement("style");
  style.appendChild(document.createTextNode(
`.flt-panel { background: rgba(255,255,255,0.95); border-radius:10px; padding:8px;
              box-shadow:0 2px 10px rgba(0,0,0,0.15); font:12px/1.4 sans-serif; }
.flt-btn { margin:2px; padding:4px 10px; border:1px solid #bbb; border-radius:6px;
           background:#fff; cursor:pointer; transition:background .12s, color .12s, border-color .12s; }
.flt-btn:hover { background:#f3f3f3; }
.flt-btn.active { background:#0D6EFD !important; color:#fff !important; border-color:#0B5ED7 !important;
                  box-shadow: 0 0 0 2px rgba(13,110,253,.18) inset; }

.split-bar { position:absolute; top:0; height:100%; width:3px;
             background: rgba(255,255,255,0.85); box-shadow:0 0 6px rgba(0,0,0,0.35);
             cursor: ew-resize; z-index: 999; }
.split-handle { position:absolute; left:50%; transform:translate(-50%,-50%);
                top:50%; width:46px; height:46px; border-radius:50%;
                background:#0D6EFD; color:#fff; border:1px solid #0B5ED7;
                box-shadow: 0 4px 14px rgba(0,0,0,0.25);
                display:flex; align-items:center; justify-content:center;
                font: 18px/1 sans-serif; user-select:none; pointer-events:auto; }`
  ));
  document.head.appendChild(style);
})();

function applyClassificationFilterToLeft(values) {
  var showExpr = values.length > 0
    ? "(" + values.map(v => "${Classification} === " + Number(v)).join(" || ") + ") && isFinite(${Classification})"
    : "false";
  if (tilesetLeft) {
    var styleInit = { show: showExpr, pointSize: 3.0 };
    if (defaultColorLeft) styleInit.color = defaultColorLeft;
    tilesetLeft.style = new Cesium.Cesium3DTileStyle(styleInit);
  }
}

function applyFromSelection() {
  applyClassificationFilterToLeft(CLASSES.filter(c => selected[c.value]).map(c => c.value));
}

// UI
function markActive(btn, active) {
  if (!btn) return;
  btn.classList.toggle("active", !!active);
}
function makeButton(label, onClick) {
  var b = document.createElement("button");
  b.type = "button";
  b.textContent = label;
  b.className = "flt-btn";
  b.addEventListener("click", onClick);
  return b;
}
function buildPanel() {
  var panel = document.createElement("div");
  panel.className = "flt-panel";
  panel.style.position = "absolute";
  panel.style.top = "10px";
  panel.style.left = "10px";
  panel.style.zIndex = "999";

  var title = document.createElement("div");
  title.textContent = "分類表示（左のみ適用）";
  title.style.fontWeight = "bold";
  title.style.marginBottom = "6px";
  panel.appendChild(title);

  var row1 = document.createElement("div");
  row1.appendChild(makeButton("全選択", function(){
    CLASSES.forEach(c => { selected[c.value] = true; markActive(btnByValue[c.value], true); });
    applyFromSelection();
  }));
  row1.appendChild(makeButton("全解除", function(){
    CLASSES.forEach(c => { selected[c.value] = false; markActive(btnByValue[c.value], false); });
    applyFromSelection();
  }));
  row1.appendChild(makeButton("反転", function(){
    CLASSES.forEach(c => {
      selected[c.value] = !selected[c.value];
      markActive(btnByValue[c.value], selected[c.value]);
    });
    applyFromSelection();
  }));
  row1.style.marginBottom = "4px";
  panel.appendChild(row1);

  var row2 = document.createElement("div");
  CLASSES.forEach(function(cls){
    var btn = makeButton(cls.label, function(){
      selected[cls.value] = !selected[cls.value];
      markActive(btn, selected[cls.value]);
      applyFromSelection();
    });
    btnByValue[cls.value] = btn;
    row2.appendChild(btn);
  });
  panel.appendChild(row2);

  viewer.container.appendChild(panel);

  CLASSES.forEach(c => markActive(btnByValue[c.value], !!selected[c.value]));
}

// スプリットハンドル（矢印のみ）
function createSplitHandle() {
  var bar = document.createElement("div");
  bar.className = "split-bar";
  bar.style.left = "50%";

  var handle = document.createElement("div");
  handle.className = "split-handle";
  handle.textContent = "↔";

  bar.appendChild(handle);
  viewer.container.appendChild(bar);

  var dragging = false;
  function setByClientX(clientX) {
    var rect = viewer.container.getBoundingClientRect();
    var clamped = Math.max(rect.left, Math.min(clientX, rect.right));
    var frac = (clamped - rect.left) / rect.width;
    viewer.scene.splitPosition = frac;
    bar.style.left = (frac * 100) + "%";
  }
  function onDown(e){
    dragging = true;
    var x = (e.touches && e.touches[0]) ? e.touches[0].clientX : e.clientX;
    if (x != null) setByClientX(x);
    e.preventDefault();
  }
  function onMove(e){
    if (!dragging) return;
    var x = (e.touches && e.touches[0]) ? e.touches[0].clientX : e.clientX;
    if (x != null) setByClientX(x);
    e.preventDefault();
  }
  function onUp(){ dragging = false; }

  [handle, bar].forEach(el => {
    el.addEventListener("mousedown", onDown);
    el.addEventListener("touchstart", onDown, {passive:false});
  });
  window.addEventListener("mousemove", onMove, {passive:false});
  window.addEventListener("touchmove", onMove, {passive:false});
  window.addEventListener("mouseup", onUp);
  window.addEventListener("touchend", onUp);
}

// 読み込み＆初期化
Promise.all([
  Cesium.Cesium3DTileset.fromIonAssetId(LEFT_ID),
  Cesium.Cesium3DTileset.fromIonAssetId(RIGHT_ID)
]).then(function([left, right]){
  tilesetLeft  = left;
  tilesetRight = right;

  tilesetLeft.splitDirection  = Cesium.SplitDirection.LEFT;
  tilesetRight.splitDirection = Cesium.SplitDirection.RIGHT;

  viewer.scene.primitives.add(tilesetLeft);
  viewer.scene.primitives.add(tilesetRight);

  return viewer.zoomTo(tilesetLeft);
}).then(function(){
  var dsLeft = tilesetLeft?.asset?.extras?.ion?.defaultStyle;
  if (Cesium.defined(dsLeft)) {
    tilesetLeft.style = new Cesium.Cesium3DTileStyle(dsLeft);
    if (Cesium.defined(dsLeft.color)) defaultColorLeft = dsLeft.color;
  } else {
    tilesetLeft.style = new Cesium.Cesium3DTileStyle({ pointSize: 3.0 });
  }
  var dsRight = tilesetRight?.asset?.extras?.ion?.defaultStyle;
  if (Cesium.defined(dsRight)) {
    tilesetRight.style = new Cesium.Cesium3DTileStyle(dsRight);
  } else {
    tilesetRight.style = new Cesium.Cesium3DTileStyle({ pointSize: 3.0 });
  }

  CLASSES.forEach(c => selected[c.value] = true);
  buildPanel();
  applyFromSelection();

  viewer.scene.splitPosition = 0.5;
  createSplitHandle();
});
  </script>
</body>
</html>


