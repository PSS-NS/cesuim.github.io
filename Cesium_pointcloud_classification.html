// 公開用トークン
Cesium.Ion.defaultAccessToken =
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI4Y2ZlMjY3NC0wMjYyLTQwM2QtYWNlYi04YjU2OWZkNjg0NjMiLCJpZCI6MTk4Njc1LCJpYXQiOjE3NTUwMDgzNjV9.bGpVqh1jBe3onROG352ZZuMisD4UBDGudxXslQkL-ns";

// 1) Viewer
var viewer = new Cesium.Viewer("cesiumContainer", {
  // ここでは terrain は後から設定（Sandcastle互換のため）
  timeline: false,
  animation: false
});

// 地形に対しての可視性
viewer.scene.globe.depthTestAgainstTerrain = true;

// 2) Japan Regional Terrain (2767062) を設定（新旧APIどちらでも動く）
(function setJapanTerrain(v) {
  function fallbackOldAPI() {
    if (Cesium.CesiumTerrainProvider &&
        typeof Cesium.CesiumTerrainProvider.fromIonAssetId === "function") {
      Cesium.CesiumTerrainProvider.fromIonAssetId(2767062)
        .then(function (provider) { v.terrainProvider = provider; })
        .catch(function (err) { console.error("Terrain(old API) error:", err); });
    } else {
      console.warn("fromIonAssetId が見当たりません。CesiumJSのバージョンを確認してください。");
    }
  }
  if (Cesium.Terrain && typeof Cesium.Terrain.fromIonAssetId === "function") {
    try {
      v.terrainProvider = Cesium.Terrain.fromIonAssetId(2767062, {
        requestVertexNormals: true
      });
    } catch (e) {
      console.error("Terrain(new API) failed, fallback to old:", e);
      fallbackOldAPI();
    }
  } else {
    fallbackOldAPI();
  }
})(viewer);

// 3) 分類（日本語ラベル）— value は PointCloudClassification に合わせる
var CLASSES = [
  { label: "地面",   value: 2  },
  { label: "フェンス", value: 4  },
  { label: "植生",   value: 5  },
  { label: "建物",   value: 6  },
  { label: "電線",   value: 14 },
  { label: "電柱",   value: 20 },
  { label: "車",     value: 21 }
];

var tileset;
var defaultColorStyle = null;

// 選択状態とボタン参照
var selected = {};
var btnByValue = {};

// --- 分類フィルタ適用 ---
function applyClassificationFilter(values) {
  var showExpr;
  if (Array.isArray(values) && values.length > 0) {
    var orTerms = values.map(function (v) { return "${Classification} === " + Number(v); });
    showExpr = "(" + orTerms.join(" || ") + ") && isFinite(${Classification})";
  } else {
    showExpr = "false";
  }
  var styleInit = { show: showExpr };
  if (defaultColorStyle) styleInit.color = defaultColorStyle;
  if (typeof styleInit.pointSize === "undefined") styleInit.pointSize = 3.0; // 見やすさ
  tileset.style = new Cesium.Cesium3DTileStyle(styleInit);
}

function applyFromSelection() {
  var active = [];
  for (var i = 0; i < CLASSES.length; i++) {
    var v = CLASSES[i].value;
    if (selected[v]) active.push(v);
  }
  applyClassificationFilter(active);
}

function setAllSelected(flag) {
  for (var i = 0; i < CLASSES.length; i++) {
    var v = CLASSES[i].value;
    selected[v] = flag;
    markActive(btnByValue[v], flag);
  }
  applyFromSelection();
}

function toggleValue(v) {
  selected[v] = !selected[v];
  markActive(btnByValue[v], selected[v]);
  applyFromSelection();
}

// --- ボタンUI ---
function markActive(btn, active) {
  if (!btn) return;
  btn.style.background = active ? "#e9e9e9" : "#fff";
  btn.style.borderColor = active ? "#888" : "#bbb";
}

function makeButton(label, onClick) {
  var b = document.createElement("button");
  b.textContent = label;
  b.style.margin = "2px";
  b.style.padding = "4px 8px";
  b.style.border = "1px solid #bbb";
  b.style.borderRadius = "6px";
  b.style.background = "#fff";
  b.style.cursor = "pointer";
  b.addEventListener("click", onClick);
  b.addEventListener("mouseenter", function () { b.style.background = "#f3f3f3"; });
  b.addEventListener("mouseleave", function () {
    var isActive = false;
    for (var v in btnByValue) { if (btnByValue[v] === b) { isActive = !!selected[v]; break; } }
    b.style.background = isActive ? "#e9e9e9" : "#fff";
  });
  return b;
}

function buildPanel() {
  var panel = document.createElement("div");
  panel.style.position = "absolute";
  panel.style.top = "10px";
  panel.style.left = "10px";
  panel.style.zIndex = "999";
  panel.style.background = "rgba(255,255,255,0.95)";
  panel.style.borderRadius = "10px";
  panel.style.padding = "8px";
  panel.style.font = "12px/1.4 sans-serif";
  panel.style.boxShadow = "0 2px 10px rgba(0,0,0,0.15)";

  var title = document.createElement("div");
  title.textContent = "分類の表示（複数選択可）";
  title.style.fontWeight = "bold";
  title.style.marginBottom = "6px";
  panel.appendChild(title);

  // 全選択/全解除/反転 + 緊急 全表示
  var row1 = document.createElement("div");
  row1.appendChild(makeButton("全選択", function () { setAllSelected(true); }));
  row1.appendChild(makeButton("全解除", function () { setAllSelected(false); }));
  row1.appendChild(makeButton("反転",   function () {
    for (var i = 0; i < CLASSES.length; i++) {
      var v = CLASSES[i].value;
      selected[v] = !selected[v];
      markActive(btnByValue[v], selected[v]);
    }
    applyFromSelection();
  }));
  row1.appendChild(makeButton("緊急 全表示", function () {
    tileset.style = new Cesium.Cesium3DTileStyle({ show: "true", pointSize: 3.0 });
  }));
  row1.style.marginBottom = "4px";
  panel.appendChild(row1);

  // 各分類トグル
  var row2 = document.createElement("div");
  for (var i = 0; i < CLASSES.length; i++) {
    (function(cls){
      var btn = makeButton(cls.label, function () { toggleValue(cls.value); });
      btnByValue[cls.value] = btn;
      row2.appendChild(btn);
    })(CLASSES[i]);
  }
  panel.appendChild(row2);

  viewer.container.appendChild(panel);
}

Cesium.Cesium3DTileset.fromIonAssetId(3621736)
  .then(function (ts) {
    tileset = ts;
    viewer.scene.primitives.add(tileset);
    return viewer.zoomTo(tileset);
  })
  .then(function () {
    // defaultStyle を尊重（色など）
    var ds = tileset &&
             tileset.asset &&
             tileset.asset.extras &&
             tileset.asset.extras.ion &&
             tileset.asset.extras.ion.defaultStyle;

    if (Cesium.defined(ds)) {
      tileset.style = new Cesium.Cesium3DTileStyle(ds);
      // 後で show だけ上書きするため、既定の color 値を保持
      if (Cesium.defined(ds.color)) defaultColorStyle = ds.color;
    } else {
      tileset.style = new Cesium.Cesium3DTileStyle({ pointSize: 3.0 });
    }

    // 分類パネル
    buildPanel();

    // 初期は全選択＝全表示
    for (var i = 0; i < CLASSES.length; i++) {
      var v = CLASSES[i].value;
      selected[v] = true;
      markActive(btnByValue[v], true);
    }
    applyFromSelection();

    // デバッグ: クリックで Classification を確認
    var handler = new Cesium.ScreenSpaceEventHandler(viewer.canvas);
    handler.setInputAction(function (click) {
      var f = viewer.scene.pick(click.position);
      if (f && typeof f.getProperty === "function") {
        try { console.log("Classification:", f.getProperty("Classification")); } catch (e) {}
      }
    }, Cesium.ScreenSpaceEventType.LEFT_CLICK);
  })
  .catch(function (e) {
    console.error(e);
  });
